<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>ranges.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
<a href="https://github.com/ttv1/src/blob/master/ranges.py"><img style="z-index: 10; position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a> 
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ranges.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p><img 
src="https://avatars0.githubusercontent.com/u/23156192?v=3&s=200"
align=left
width=120>
&nbsp;<br>&nbsp;<br>
<em>Just another <a href="http://ttv1.github.com">Timm Tool</a>.<br> Discuss this file <a href="https://github.com/ttv1/src/issues">on Github</a>. <img  align=middle src="https://github.com/favicon.ico"></em>
<br clear=all></p>
<hr />
<p>from cliffsDelta import cd as different</p>
<p>def div(lst):
 return ranges(lst)</p>
<p>def sdiv(lst,
        x   = lambda z:z[ 0],
        y   = lambda z:z[-1],
        key = lambda z:z[ 0]):
 return ranges(lst, key=key, x=x, y=y)</p>
<p>def ediv(lst,
        x   = lambda z:z[ 0],
        y   = lambda z:z[-1],
        key = lambda z:z[ 0]):
 def fayyadIranni(lhs,rhs,all,score):
   gain  = all.ent() - score
   delta = math.log(3**all.k()-2,2) - (all.ke() - lhs.ke() - rhs.ke())
   return gain &gt; (math.log(all.n-1,2) + delta)/all.n
 return ranges(lst,
               ynum=False,
               goodysplit=fayyadIranni,key=key, x=x, y=y)</p>
<p>def scottknott(d):
 def expectedMuChange(lhs,rhs,all):
   return lhs.n/all.n * abs(lhs.median() - all.median())<strong>2 + \
     rhs.n/all.n * abs(rhs.median() - all.median())</strong>2
 return ddiv(d,expectedMuChange)</p>
<p>def ddiv(d,f=None):
  lst=[]
  for k,v in d.items():
    tmp=num(v)
    tmp.label= k
    lst += [tmp]
  return ranges(lst,
                flat=False,
              x   = lambda z:z.all,
              y   = lambda z:z.all,
              key = lambda z:z.median())</p>
<h1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-----------------------------------</h1>
<p>def ranges(lst,
          d          = 0.3,
          cliffsDelta= 0.147,
          enough     = None,
          enoughth   = 0.71,
          epsilon    = None,
          evaly      = None,
          flat       = True,
          goodxsplit = None,
          goodysplit = None,
          greedy     = True,
          label      = "ranges",
          rnd        = 3,
          trivial    = 1.05, # 1%
          key        = lambda z:z,
          verbose    = False,
          x          = lambda z:z,
          y          = lambda z:z,
          ynum       = True,
         ):
 def expectedWriggle(lhs,rhs,all):
    return lhs.n/all.n * lhs.wriggle() + \
          rhs.n/all.n * rhs.wriggle()
 def yes(<em>l,</em>*d): return True
 evaly= evaly or expectedWriggle
 goodxsplit = goodxsplit or yes
 goodysplit = goodysplit or yes</p>
<p>def stats(segment, xall, yall,flat):
    xs,ys = num(),yklass()
    if flat:
      for one in segment:
        x1 = x(one)
        y1 = y(one)
        xs   + x1
        xall + x1
        ys   + y1
        yall + y1
    else:
      for x1 in segment.all:
        xs.label = segment.label
        ys.label = segment.label
        xs   + x1
        xall + x1
        ys   + x1
        yall + x1
    return xs,ys
 #-----------------
 def summary(segments):
   xall,yall=[],[]
   xs, ys  = {},{}
   for i,(x,y) in enumerate(segments[::-1]):
     j    = len(segments) - i - 1
     xall += x.all
     yall += y.all
     newx = num(xall)
     newy = yklass(yall)
     xs[j] = newx
     ys[j] = newy
     #print("!!!",j,newx,newy)
   return xs, ys, num(xall), yklass(yall)
 #-----------------
 def divide(segments, out,lvl, cut=None):
   xrhsall, yrhsall, xoverall, yoverall = summary(segments)
   score, score1 = yoverall.wriggle(), None
   xlhs, ylhs    = num(), yklass()
   for i,(x,y) in enumerate(segments[:-1]):
     xrhs = xrhsall[i+1]
     yrhs = yrhsall[i+1]
     [xlhs+z for z in x.all]
     [ylhs+z for z in y.all]
     if xlhs.median() + epsilon &lt; xrhs.median():
       score1 = evaly(ylhs,yrhs,yoverall)
       if score1<em>trivial &lt; score:
         if yklass == num:
           if not greedy or ylhs.median()</em>trivial &lt; yrhs.median(): 
             if goodxsplit(xlhs,xrhs,xoverall): # hook for stats
               cut,score = i+1,score1<br />
         else:
           if not greedy or ylhs.mode != yrhs.mode:
             if goodysplit(ylhs,yrhs,yoverall, score1):
               if goodxsplit(xlhs,xrhs,xoverall): # hook for stats
                 cut,score = i+1,score1
   if verbose:
     score1 = round(score1,rnd) if score1 else '.'
     print(' ..'<em>lvl,xoverall.n,score1)
   if cut:
     divide(segments[:cut], out= out, lvl= lvl+1)
     divide(segments[cut:], out= out, lvl= lvl+1)
   else:
     assert xoverall.lo &lt;= xoverall.hi
     out.append(dict(label   = label, score = score,
                     x       = xoverall,
                     y       = yoverall,
                     has     = segments,id=len(out)))
   return out
 #------------------
 def chunks(l, n):
   for i in range(0, len(l), n):  yield l[i:i + n]
 #------------------
 if not lst:
   return []
 else:
   lst        = lst[:]
   yklass     = num if ynum else sym
   xall, yall = num(), yklass()
   width      = int(enough or len(lst)</em>*enoughth)
   ordered    = sorted(lst,key=key)
   segments   = ordered if not flat else [z for z in chunks(ordered,width)]
   parts      = [stats(segment, xall, yall,flat) for segment in segments]
   epsilon    = epsilon or d * xall.wriggle()
   return divide(parts,out=[], lvl=0)</p>
<p>class ordered:
  def <strong>init</strong>(i,lst):
     i.sorted= False
     i._median = None
     i.all = lst
  def <strong>add</strong>(i,x):
     i.sorted=False
     i.all += [x]
  def wriggle(i):
    return i.median()
  def median(i):
    if not i.sorted or not i._median:
      i.sorted = True
      i.all    = sorted(i.all)
      n        = len(i.all)
      p  =  q  = n//2
      if n &lt; 3:
        p,q = 0, n-1
      elif not n % 2:
        q = p -1
      i._median = i.all[p] if p==q else (i.all[p]+i.all[q])/2
    return i._median</p>
<p>class num:
   def <strong>init</strong>(i,inits=[]):
     i.lo, i.hi, i.n, i.mu, i.m2 = 1e32,-1e32,0,0,0
     i.sd = None
     i.all = []
     i.ordered=ordered(i.all)
     [i + x for x in inits]
   def <strong>add</strong>(i,x):
     i.ordered + x
     i.sorted=False
     i.lo   = min(x, i.lo)
     i.hi   = max(x, i.hi)
     i.n   += 1
     delta  = x - i.mu
     i.mu  += delta/i.n
     i.m2  += delta<em>(x - i.mu)
     if i.n &gt; 1:
       i.sd = (i.m2/(i.n-1))</em>*0.5</p>
<p>def wriggle(i):
     return i.sd
   def median(i):
     return i.ordered.median()
   def <strong>repr</strong>(i):
     return "(:lo %.4f :hi %.4f :n %.4f :med %.4f :sd %.4f)" % (i.lo, i.hi, i.n,i.median(),i.sd)</p>
<p>class sym:
   def <strong>init</strong>(i,inits=[]):
     i.n, i.most, i.mode, i.counts = 0,0,None,{}
     i.all=[]
     i._ent=None
     [i + x for x in inits]
   def <strong>add</strong>(i,x):
     i.all += [x]
     i.n += 1
     i._ent=None
     count= i.counts[x] = i.counts.get(x,0) + 1
     if count &gt; i.most:
       i.most,i.mode=count,x
   def wriggle(i): return i.ent()
   def ent(i):
     if i._ent is None:
       i._ent = 0
       for k in i.counts:
         p    = i.counts[k]/i.n
         i._ent -= p<em>math.log(p,2)
     return i._ent
   def k(i):  return len(i.counts.keys())
   def ke(i): return i.k()</em>i.ent()
   def <strong>repr</strong>(i):
     return 'n: %s most: %s more: %s ent: %s' % (i.n, i.most, i.more, i.ent())</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">____</span>


<span class="o">&lt;</span><span class="n">img</span> <span class="n">align</span><span class="o">=</span><span class="n">right</span> 
<span class="n">src</span><span class="o">=</span><span class="s">&quot;https://raw.githubusercontent.com/timm/timm.github.io/master/timm.png&quot;</span>
<span class="n">width</span><span class="o">=</span><span class="mi">170</span><span class="o">&gt;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Copyleft</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">Copyright</span> <span class="o">&amp;</span><span class="n">copy</span><span class="p">;</span> <span class="mi">2016</span> <span class="n">Tim</span> <span class="n">Menzies</span> <span class="o">&lt;</span><span class="n">tim</span><span class="nd">@menzies.us</span><span class="o">&gt;</span>

<span class="n">This</span> <span class="n">program</span> <span class="ow">is</span> <span class="n">free</span> <span class="n">software</span><span class="o">.</span> <span class="n">It</span> <span class="n">comes</span> <span class="n">without</span> <span class="nb">any</span> <span class="n">warranty</span><span class="p">,</span> <span class="n">to</span>
<span class="n">the</span> <span class="n">extent</span> <span class="n">permitted</span> <span class="n">by</span> <span class="n">applicable</span> <span class="n">law</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">redistribute</span> <span class="n">it</span>
<span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">modify</span> <span class="n">it</span> <span class="n">under</span> <span class="n">the</span> <span class="n">terms</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Do</span> <span class="n">What</span> <span class="n">The</span> <span class="n">F</span><span class="o">*</span><span class="n">ck</span> <span class="n">You</span> <span class="n">Want</span>
<span class="n">To</span> <span class="n">Public</span> <span class="n">License</span><span class="p">,</span> <span class="n">Version</span> <span class="mi">2</span><span class="p">,</span> <span class="k">as</span> <span class="n">published</span> <span class="n">by</span> <span class="n">Sam</span> <span class="n">Hocevar</span><span class="o">.</span> <span class="n">See</span>
<span class="p">[</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">wtfpl</span><span class="o">.</span><span class="n">net</span><span class="p">](</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">wtfpl</span><span class="o">.</span><span class="n">net</span><span class="p">)</span> <span class="k">for</span> <span class="n">more</span> <span class="n">details</span><span class="o">.</span>

<span class="n">Share</span> <span class="ow">and</span> <span class="n">enjoy</span><span class="o">.</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
