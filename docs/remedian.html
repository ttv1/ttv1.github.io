<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>remedian.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>remedian.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Incrementally find median.<br />
Copyright (c) 2016, Tim Menzies, BSD (2-Clause).</p>
<h2>Install</h2>
<p>Download <a href="../remedian.py">remedian.py</a>.</p>
<p>Optionally, download the unit tests <a href="../remedianeg.py">remedianeg.py</a>
and run them using <code>pypy3 remedianeg.py</code> (and all tests should
pass).</p>
<h2>About</h2>
<p>Implemented via a set of lists. New numbers are added to lst[i] and when it
fills up, it posts its median to lst[i+1]. When a remedian is queried for the
current median, it returns the median of the last list with any numbers.</p>
<p>Example usage:</p>
<pre><code>z=remedian()
for i in range(1000):
  z + i
  if not i % 100:
    print(i, z.median())
</code></pre>
<p>Based on <em>The Remedian:A Robust Averaging Method for Large Data Sets Peter</em>
J. Rousseeuw and Gilbert W. Bassett Jr.  Journal of the American Statistical
Association March 1990, Vol. 85, No. 409, Theory and Methods
http://web.ipac.caltech.edu/staff/fmasci/home/astro_refs/Remedian.pdf</p>
<p>The test code (at bottom) compares this rig to</p>
<ol>
<li>using Python's built-in sort</li>
<li>then reporing the middle number</li>
</ol>
<p>Assuming lists of length 64, remedian is about 30% faster than raw sort after
500 items (while at the same time, avoids having to store all the numbers in
RAM).</p>
<p>Further, remedian's computed median is within 1% (or less) of the medians found
via Python's sort.</p>
<hr />
<h2>Source Code</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Watch over a stream of numbers, incrementally learning their median.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">remedian</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>  <span class="c"># after some experimentation, 64 works ok</span>
               <span class="n">lvl</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="s">&quot;Constructor&quot;</span>
    <span class="n">i</span><span class="o">.</span><span class="n">all</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">lvl</span> <span class="o">=</span> <span class="p">[],</span><span class="n">k</span><span class="p">,</span><span class="n">lvl</span>
    <span class="n">i</span><span class="o">.</span><span class="n">more</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>When full, push the median of current values to next list, then reset.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">i</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">i</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">all</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="o">.</span><span class="n">k</span><span class="p">:</span>
      <span class="n">i</span><span class="o">.</span><span class="n">more</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">more</span> <span class="ow">or</span> <span class="n">remedian</span><span class="p">(</span><span class="n">lvl</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">lvl</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
      <span class="n">i</span><span class="o">.</span><span class="n">more</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">_median</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">all</span><span class="p">)</span>
      <span class="n">i</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>If there is a next list, ask its median. Else, work it out locally.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="n">i</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">more</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">more</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">_median</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">all</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Primitive: return the median of a list of numbers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">_median</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">lst</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
      <span class="n">n</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
      <span class="n">p</span>  <span class="o">=</span> <span class="n">q</span>  <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">i</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="o">==</span><span class="n">q</span> <span class="k">else</span> <span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">+</span><span class="n">lst</span><span class="p">[</span><span class="n">q</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">_cache</span>
        
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">random</span><span class="o">,</span><span class="nn">time</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">r</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">random</span>
  <span class="n">q</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>test0: basic usage</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">z</span><span class="o">=</span><span class="n">remedian</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
     <span class="n">z</span> <span class="o">+</span> <span class="n">i</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">median</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>test1: just something simple</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  
  <span class="n">z</span><span class="o">=</span><span class="n">remedian</span><span class="p">()</span>
  <span class="n">lst</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
  <span class="p">[</span><span class="n">z</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
  <span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lst</span><span class="p">)[</span><span class="mi">500</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>test2: store increasing amount of numbers
       with different values for k</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">]:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
      <span class="n">n</span> <span class="o">=</span> <span class="mi">50</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">f</span>
      <span class="n">repeats</span><span class="p">,</span><span class="n">terr</span><span class="p">,</span><span class="n">merr</span><span class="p">,</span><span class="n">tall</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeats</span><span class="p">):</span>
        <span class="n">z</span><span class="o">=</span><span class="n">remedian</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
          <span class="n">z</span> <span class="o">+</span> <span class="n">x</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lst</span><span class="p">[:])[</span><span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">merr</span> <span class="o">+=</span> <span class="n">m1</span><span class="o">/</span><span class="n">m2</span>
        <span class="n">terr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">tall</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                 <span class="n">runtTime</span><span class="o">=</span>       <span class="n">q</span><span class="p">(</span><span class="n">tall</span><span class="o">/</span><span class="n">repeats</span><span class="p">),</span>
                 <span class="n">medianError</span><span class="o">=</span>    <span class="n">q</span><span class="p">(</span><span class="n">merr</span><span class="o">/</span><span class="n">repeats</span><span class="p">),</span>
                 <span class="n">timeDifference</span><span class="o">=</span> <span class="n">q</span><span class="p">(</span><span class="n">terr</span><span class="o">/</span><span class="n">repeats</span><span class="p">)))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <pre><code>&gt; time pypy3 remedian.py
0 0
100 31.5
200 95.5
300 127.5
400 191.5
500 223.5
600 287.5
700 319.5
800 383.5
900 447.5
0.2676937558483627 0.2715219408536629

{'k': 8, 'n': 50, 'runtTime': 0.0002, 'medianError': 1.0223, 'timeDifference': 17.1506}
{'k': 8, 'n': 500, 'runtTime': 0.0004, 'medianError': 1.0341, 'timeDifference': 5.38}
{'k': 8, 'n': 5000, 'runtTime': 0.0007, 'medianError': 1.0299, 'timeDifference': 0.9414}
{'k': 8, 'n': 50000, 'runtTime': 0.004, 'medianError': 1.0305, 'timeDifference': 0.4372}

{'k': 16, 'n': 50, 'runtTime': 0.0002, 'medianError': 0.949, 'timeDifference': 51.1795}
{'k': 16, 'n': 500, 'runtTime': 0.0002, 'medianError': 1.0058, 'timeDifference': 2.5798}
{'k': 16, 'n': 5000, 'runtTime': 0.0006, 'medianError': 1.0126, 'timeDifference': 0.8711}
{'k': 16, 'n': 50000, 'runtTime': 0.0042, 'medianError': 1.0072, 'timeDifference': 0.4731}

{'k': 32, 'n': 50, 'runtTime': 0.0, 'medianError': 0.9977, 'timeDifference': 2.2678}
{'k': 32, 'n': 500, 'runtTime': 0.0001, 'medianError': 0.9941, 'timeDifference': 1.0468}
{'k': 32, 'n': 5000, 'runtTime': 0.0005, 'medianError': 0.9958, 'timeDifference': 0.7138}
{'k': 32, 'n': 50000, 'runtTime': 0.0043, 'medianError': 1.0009, 'timeDifference': 0.5116}

{'k': 64, 'n': 50, 'runtTime': 0.0, 'medianError': 0.9652, 'timeDifference': 2.685}
{'k': 64, 'n': 500, 'runtTime': 0.0, 'medianError': 0.9904, 'timeDifference': 0.8901}
{'k': 64, 'n': 5000, 'runtTime': 0.0005, 'medianError': 0.9982, 'timeDifference': 0.7761}
{'k': 64, 'n': 50000, 'runtTime': 0.0046, 'medianError': 1.0019, 'timeDifference': 0.5482}

{'k': 128, 'n': 50, 'runtTime': 0.0, 'medianError': 0.9634, 'timeDifference': 2.5693}
{'k': 128, 'n': 500, 'runtTime': 0.0, 'medianError': 0.9898, 'timeDifference': 0.9376}
{'k': 128, 'n': 5000, 'runtTime': 0.0005, 'medianError': 0.9989, 'timeDifference': 0.7821}
{'k': 128, 'n': 50000, 'runtTime': 0.0054, 'medianError': 0.9998, 'timeDifference': 0.6213}

real    0m8.749s
user    0m8.407s
sys 0m0.280s
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
